#!/usr/bin/env bash

L_PATH=$HOME/Projects/securityengineerd.cloud
R_PATH=/home/nextjs/securityengineerd.cloud
R_HOST=ssh.artisangift.co
R_USER=root

echo "Stopping Portfolio Service..."
sleep 3 && systemctl stop onceui-prod && \
    echo " - success" || { echo " - Process aborted, failed to stop service"; exit 1; }

echo "Applying correct ownership and permissions to portfolio data..." 
sleep 5 && chown -Rv nextjs:nextjs /home/nextjs/* &&
    echo " - success" || { echo " - Process aborted, failed to apply ownership and permissions"; exit 1; }

echo "Building production-ready portfolio..."
/usr/bin/runuser -l nextjs "$( cd /home/nextjs/securityengineerd.cloud; /usr/bin/npm run build > $HOME/build.log )" && \
    echo " - success" || { echo " - Process aborted, failed to build portfolio"; cat /home/nextjs/build.log; exit 1; }

echo "Starting updated Portfolio, one moment..."
systemctl start onceui-prod && \
    echo " - success" || { echo " - Process aborted, failed to start portfolio service"; exit 1; }

systemctl status onceui-prod


rsync -avzP ./* root@ssh.artisangift.co:/home/nextjs/securityengineerd.cloud/
